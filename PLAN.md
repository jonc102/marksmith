# MarkdownPaste - macOS Menu Bar App Implementation Plan

## Context

Copying text from `.md` files and pasting into apps like Slack or Telegram results in raw Markdown syntax (hashes, asterisks, etc.) appearing literally instead of rendering as formatted text. This happens because text editors only place plain text on the clipboard — without an HTML or RTF representation, receiving apps have nothing to render.

**Goal**: Build a native macOS menu bar app that automatically monitors the clipboard, detects Markdown content, converts it to rich text (HTML + RTF), and writes it back — so pasting "just works" with formatting in any app.

---

## Architecture Overview

- **App type**: Menu bar-only utility (no Dock icon, no main window)
- **Tech**: Swift + SwiftUI, macOS 13+ (Ventura) for `MenuBarExtra` and `SMAppService`
- **Bundle ID**: `com.jonathancheung.MarkdownPaste`
- **Single dependency**: Apple's `swift-markdown` (SPM) — bundles `cmark-gfm` for full GFM support
- **Distribution**: Code-signed + notarized `.dmg`

### Data Flow

```
Timer (0.5s) → changeCount changed?
  → Self-marker present? Skip
  → Already has HTML/RTF? Skip
  → Extract plain text
  → MarkdownDetector: heuristic score ≥ threshold?
  → MarkdownConverter: MD → AST → HTML (styled) + RTF
  → ClipboardWriter: write .string + .html + .rtf + .marker back
```

---

## Project Structure

```
MarkdownPaste/
├── MarkdownPaste.xcodeproj          # Generated by XcodeGen
├── MarkdownPaste/
│   ├── App/
│   │   ├── MarkdownPasteApp.swift   # @main, MenuBarExtra + Settings scenes
│   │   ├── AppDelegate.swift        # Lifecycle, start/stop monitor
│   │   └── AppState.swift           # @MainActor singleton, @AppStorage prefs
│   ├── Views/
│   │   ├── MenuBarView.swift        # Dropdown: toggle, status, settings, quit
│   │   └── SettingsView.swift       # General + Detection tabs
│   ├── Services/
│   │   ├── ClipboardMonitor.swift   # Timer-based NSPasteboard polling
│   │   ├── MarkdownDetector.swift   # 15 weighted regex patterns
│   │   ├── MarkdownConverter.swift  # swift-markdown HTMLVisitor → HTML + RTF
│   │   └── ClipboardWriter.swift    # NSPasteboardItem multi-format write
│   ├── Utilities/
│   │   ├── Constants.swift          # Polling interval, max size, threshold
│   │   └── PasteboardTypes.swift    # Marker type extension
│   └── Resources/
│       ├── Assets.xcassets/         # AppIcon
│       └── Info.plist               # LSUIElement=YES, NSPasteboardUsageDescription
├── MarkdownPasteTests/
│   ├── MarkdownDetectorTests.swift  # 22 tests
│   ├── MarkdownConverterTests.swift # 23 tests
│   └── ClipboardWriterTests.swift   # 11 tests
├── Scripts/
│   └── build-release.sh            # Archive, sign, notarize, DMG
├── ExportOptions.plist              # developer-id export config
├── project.yml                      # XcodeGen configuration
└── README.md
```

---

## Key Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Clipboard monitoring | Polling (0.5s Timer) | macOS has no clipboard change notification API. <1% CPU. |
| Loop prevention | Marker pasteboard type + changeCount | Dual strategy prevents all re-processing of own writes |
| Skip rich content | Check for existing .html/.rtf | Don't re-process content copied from web/docs |
| Markdown parser | Apple's swift-markdown | Official, bundles cmark-gfm, full GFM, HTMLFormatter built-in |
| RTF generation | NSAttributedString pipeline | Built into AppKit, no extra dependency |
| Sandboxing | Disabled | Clipboard monitoring requires general pasteboard access; distributing via DMG (not App Store) |
| Min macOS version | 13.0 (Ventura) | Required for MenuBarExtra and SMAppService APIs |
| Settings window | SwiftUI `SettingsLink` | Native macOS 13+ API, replaces fragile `NSApp.sendAction(Selector(...))` |
| AppState thread safety | `@MainActor` | Required for SwiftUI compatibility; Timer fires on main thread |

---

## Edge Cases Handled

- **Self-triggered changes**: Marker type + changeCount tracking prevents infinite loops
- **Already-rich clipboard**: Skipped if .html or .rtf already present
- **Very large content**: Skip if >100KB to avoid blocking main thread
- **Non-text clipboard** (images, files): `guard let plainText` returns early
- **Empty/whitespace clipboard**: Trimmed check prevents processing blank content
- **macOS 16 privacy prompts**: NSPasteboardUsageDescription provides rationale; graceful nil handling if denied
- **False positive detection**: Low default threshold (2) catches most Markdown; user can increase to 5 for conservative mode
- **XSS in code blocks**: HTML entities escaped in all text output including code blocks

---

## Completed Milestones

### Milestone 1: Project Skeleton ✅

- [x] Create Xcode project directory structure
- [x] Create `project.yml` (XcodeGen) with macOS 13 deployment target
- [x] Add `swift-markdown` SPM dependency (`https://github.com/swiftlang/swift-markdown.git`, from 0.4.0)
- [x] Create `Info.plist` with `LSUIElement = true` and `NSPasteboardUsageDescription`
- [x] Create `Assets.xcassets` with `AppIcon.appiconset`
- [x] Create `MarkdownPaste.entitlements` (sandbox disabled)
- [x] Create `Constants.swift` — app name, bundle ID, polling interval (0.5s), max content size (100KB), default threshold (2)
- [x] Create `PasteboardTypes.swift` — `NSPasteboard.PasteboardType.markdownPasteMarker` extension
- [x] Create `AppState.swift` — `@MainActor` singleton with `@AppStorage` properties, `@Published` runtime state, `SMAppService` login item management
- [x] Create `MarkdownPasteApp.swift` — `@main`, `MenuBarExtra` with custom `MenuBarIcon` template image, `Settings` scene
- [x] Create `AppDelegate.swift` — `NSApplicationDelegateAdaptor`, creates and manages `ClipboardMonitor`

---

### Milestone 2: Markdown Detection Engine ✅

- [x] Create `MarkdownDetector.swift` with 15 pre-compiled `NSRegularExpression` patterns (all with correct `.anchorsMatchLines` options where needed)
- [x] Implement `score(text:) -> Int` — sum weighted matches, cap each pattern at 3 matches
- [x] Implement `detect(text:threshold:) -> Bool` — score ≥ threshold
- [x] Create `MarkdownDetectorTests.swift` — 22 tests: 15+ positive, 6 negative, 6 edge cases

---

### Milestone 3: Markdown-to-Rich-Text Converter ✅

- [x] Create `MarkdownConverter.swift` with `convert(markdown:) -> (html: String, rtf: Data?)`
- [x] Implement `HTMLVisitor` conforming to `MarkupVisitor` protocol with all GFM elements (22 visit methods)
- [x] Implement CSS styling wrapper with system font, code backgrounds, table borders, blockquote styling
- [x] Implement RTF generation via `NSAttributedString(html:documentAttributes:)`
- [x] Implement HTML entity escaping (`<`, `>`, `&`, `"`)
- [x] Create `MarkdownConverterTests.swift` — 23 tests covering all elements, RTF, escaping, CSS

---

### Milestone 4: Clipboard Read/Write Integration ✅

- [x] Create `ClipboardWriter.swift` with marker-inclusive multi-format write
- [x] Create `ClipboardMonitor.swift` with 10-step guard pipeline, weak self timer, RunLoop.common mode
- [x] Create `ClipboardWriterTests.swift` — 11 tests for types, marker, content integrity
- [x] Wire `AppDelegate` to create and start `ClipboardMonitor`

---

### Milestone 5: Menu Bar UI & Settings ✅

- [x] Create `MenuBarView.swift` — toggle, status display, `SettingsLink`, quit button with keyboard shortcuts
- [x] Create `SettingsView.swift` — `TabView` with General tab (enable, login, RTF toggles) and Detection tab (sensitivity slider with labels)
- [x] `MarkdownPasteApp.swift` includes both `MenuBarExtra` and `Settings` scenes with `@EnvironmentObject`

---

### Milestone 6: Project Configuration & Build ✅

- [x] Finalize `project.yml` with app target, test target, SPM dependency, signing config
- [x] Create `Scripts/build-release.sh` (archive, sign, notarize, DMG with create-dmg fallback to hdiutil)
- [x] Create `ExportOptions.plist` (method: developer-id, automatic signing)
- [x] XcodeGen successfully generates `.xcodeproj`

---

## Remaining Tasks

### Milestone 7: Build Verification & Xcode Setup ✅

**Goal**: Verify the project compiles and all tests pass in Xcode.

- [x] Run `xcodegen generate` to create fresh `.xcodeproj`
- [x] Build the app: `xcodebuild build -project MarkdownPaste.xcodeproj -scheme MarkdownPaste`
- [x] Run all tests: `xcodebuild test -project MarkdownPaste.xcodeproj -scheme MarkdownPaste`

**Result**: Build succeeded with 0 errors. All 70 tests pass.

---

### Milestone 8: Manual QA Testing
**Goal**: Verify end-to-end functionality with real clipboard operations.

- [ ] Launch the app — verify it appears in the menu bar with the custom clipboard→document icon
- [ ] **Positive conversion tests**:
  - [ ] Copy `# Heading\n**bold**\n- list item` from Terminal → paste in TextEdit → should render formatted
  - [ ] Copy a full GFM document with tables → paste in Apple Notes → table should render
  - [ ] Copy code block with triple backticks → paste in rich text app → should show code formatting
  - [ ] Copy task list `- [x] Done\n- [ ] Todo` → paste → should show checkboxes
- [ ] **Negative tests (should NOT convert)**:
  - [ ] Copy plain English sentence → paste → should remain plain text
  - [ ] Copy text from a web browser (already has HTML) → paste → original rich formatting preserved
  - [ ] Copy an image → paste → image should paste normally
  - [ ] Copy text > 100KB → paste → should not be processed
- [ ] **Settings tests**:
  - [ ] Toggle "Enabled" off → copy Markdown → paste → should remain raw
  - [ ] Toggle "Enabled" back on → copy Markdown → paste → should convert
  - [ ] Adjust sensitivity slider to 5 → copy simple Markdown → should NOT convert (too few patterns)
  - [ ] Adjust sensitivity slider to 1 → copy simple Markdown → should convert
  - [ ] Toggle "Include RTF" off → verify paste still works (HTML-only)
  - [ ] Toggle "Launch at Login" → verify `SMAppService` registration (check System Settings > General > Login Items)
- [ ] **Menu bar tests**:
  - [ ] Verify conversion counter increments after each conversion
  - [ ] Verify "Last: X ago" updates with relative time
  - [ ] Verify Settings... opens the preferences window
  - [ ] Verify Quit terminates the app
- [ ] **Edge case tests**:
  - [ ] Rapid copy-paste (multiple copies in < 0.5s) — no crashes, no infinite loops
  - [ ] Copy Markdown, then copy non-Markdown — second copy should not have rich text from first
  - [ ] App remains responsive during conversion of large Markdown (50-100KB)

**How to execute**: Run the app from Xcode (Product > Run or ⌘R), then perform each test manually. Keep a checklist of pass/fail results.

**Acceptance**: All tests pass. No crashes, no infinite loops, no incorrect conversions.

---

### Milestone 9: App Icon Design
**Goal**: Create a proper app icon for the menu bar and app bundle.

- [ ] Design a 1024x1024 app icon (the master size):
  - Concept: A document with a Markdown `#` symbol transforming into formatted rich text
  - Or: A clipboard icon with the Markdown mark (`M↓`) in the app's brand color
  - Style: Follow Apple's macOS icon guidelines (rounded rectangle, slight 3D perspective)
- [ ] Export to all required sizes for `AppIcon.appiconset`:
  - 16x16 @1x, @2x
  - 32x32 @1x, @2x
  - 128x128 @1x, @2x
  - 256x256 @1x, @2x
  - 512x512 @1x, @2x
- [ ] Place PNGs in `MarkdownPaste/Resources/Assets.xcassets/AppIcon.appiconset/`
- [ ] Update `Contents.json` with filename references
- [x] Custom menu bar icon (18x18 template image) — `MenuBarIcon.imageset` generated by `Scripts/generate-menubar-icon.swift`

**How to execute**: Use a design tool (Figma, Sketch, or macOS Preview) to create the icon. Export at each resolution. Copy PNGs into the asset catalog and update the JSON manifest.

**Acceptance**: App icon appears in Finder, Dock (if shown), and About window. Menu bar shows a clear, recognizable icon.

---

### Milestone 10: Performance Profiling
**Goal**: Verify the app meets performance targets and doesn't drain battery.

- [ ] Measure `MarkdownDetector.score()` execution time on typical documents (target: <5ms)
- [ ] Measure `MarkdownConverter.convert()` execution time on typical documents (target: <100ms)
- [ ] Measure CPU usage during idle polling (target: <1%)
- [ ] Measure memory usage at rest (target: <20MB)
- [ ] Profile with Instruments (Time Profiler) during active conversion
- [ ] Test with large Markdown files (50KB, 100KB) to verify the size guard works
- [ ] Verify no memory leaks with Instruments (Leaks tool)

**How to execute**:
```swift
// Add temporary timing code to ClipboardMonitor.checkClipboard():
let start = CFAbsoluteTimeGetCurrent()
let result = converter.convert(markdown: plainText)
let elapsed = CFAbsoluteTimeGetCurrent() - start
print("Conversion took \(elapsed * 1000)ms")
```

Or use Instruments: Product > Profile (⌘I) in Xcode, choose Time Profiler or Leaks.

**Acceptance**: Detector <5ms, converter <100ms, idle CPU <1%, no memory leaks.

---

### Milestone 11: Unsigned DMG Distribution
**Goal**: Package the app into a `.dmg` for sharing without an Apple Developer license.

The app will trigger a Gatekeeper "unidentified developer" warning. Recipients bypass it by right-clicking → Open → Open (one-time). This is acceptable for early distribution to validate demand before investing in a $99/year Developer ID.

**Prerequisites**:
- `create-dmg` tool: `brew install create-dmg` (optional — falls back to `hdiutil`)

- [ ] Build the Release archive:
  ```bash
  cd /Users/jonathancheung/Documents/GitHub/markdown-copy-tool
  ./Scripts/build-release.sh
  ```
- [ ] Test the DMG on your own Mac:
  - Open `build/MarkdownPaste.dmg`
  - Drag app to Applications
  - Launch — expect Gatekeeper warning on first run
  - Right-click → Open → Open to bypass
  - Verify the app works (menu bar icon, clipboard conversion)
- [ ] Test on another Mac or user account:
  - Copy the DMG to another machine
  - Same right-click → Open flow
  - Verify full functionality
- [ ] Prepare distribution README / instructions for recipients:
  - Include a one-line install instruction: "Right-click the app → Open → Open on first launch"
  - Host DMG on GitHub Releases, Google Drive, or personal site
- [ ] Create a GitHub Release:
  ```bash
  gh release create v1.0.0 build/MarkdownPaste.dmg \
    --title "MarkdownPaste v1.0.0" \
    --notes "Initial release. Right-click → Open → Open on first launch to bypass Gatekeeper."
  ```

**Acceptance**: DMG installs and runs on a clean Mac after the one-time Gatekeeper bypass.

---

### Milestone 12: Polish & Enhancements (v1.1)
**Goal**: Quality-of-life improvements based on early user feedback.

Prioritize based on what users actually request:

- [ ] **Dynamic menu bar icon**: Show different icon states (enabled vs disabled, conversion in progress)
  - Use `Image("MenuBarIcon")` / `Image("MenuBarIconDisabled")` in `MenuBarExtra` for enabled/disabled states
- [ ] **Conversion notification**: Brief system notification or menu bar flash on successful conversion
  - Use `UNUserNotificationCenter` for optional toast notifications
- [ ] **Exclude-app list**: Allow users to disable conversion when copying from specific apps
  - Read `NSPasteboard.general.name` or check frontmost app via `NSWorkspace.shared.frontmostApplication`
  - Store excluded bundle IDs in `@AppStorage`
- [ ] **Custom CSS themes**: Let users customize the HTML styling (light/dark, font, colors)
  - Add a "Theme" tab in Settings with presets (Default, GitHub, Minimal)
  - Store custom CSS in `@AppStorage` as a string
- [ ] **Conversion history log**: Show recent conversions in the menu bar dropdown
  - Store last N conversions as `[(date: Date, preview: String)]` in memory
  - Display in a submenu below the status line
- [ ] **Keyboard shortcut**: Global hotkey to toggle enable/disable
  - Use `KeyboardShortcuts` SPM package or `NSEvent.addGlobalMonitorForEvents`
- [ ] **About window**: Show version, credits, and link to GitHub
  - Create `AboutView.swift` with app icon, version from `Bundle.main`, and links
- [ ] **First-run onboarding**: Brief explanation on first launch
  - Show a welcome window on first launch (check `UserDefaults` flag)
  - Request clipboard access permission explicitly
- [ ] **Dark mode CSS**: Detect system appearance and apply matching CSS
  - Use `@Environment(\.colorScheme)` or `NSApp.effectiveAppearance` to switch CSS
- [ ] **Paste preview**: Show a small preview of converted output before writing to clipboard
  - Add a "Preview before converting" toggle in Settings
  - Display a small popover with HTML preview using `WKWebView`

---

### Milestone 13: Monetization — Free Trial + Lifetime Unlock (v2.0)
**Goal**: Once demand is validated, sign up for Apple Developer Program and monetize with a free trial and one-time lifetime purchase.

**Prerequisites**:
- Proven demand (download count, user feedback, feature requests)
- Apple Developer Program enrollment ($99/year)
- Payment infrastructure decision

**Phase 1: Apple Developer Program & Signed Distribution**
- [ ] Enroll in Apple Developer Program ($99/year) at https://developer.apple.com/programs/
- [ ] Set up Developer ID Application certificate (Xcode > Settings > Accounts)
- [ ] Configure signing in `project.yml`:
  ```yaml
  settings:
    base:
      CODE_SIGN_IDENTITY: "Developer ID Application"
      DEVELOPMENT_TEAM: "YOUR_TEAM_ID"
  ```
- [ ] Store notarization credentials:
  ```bash
  xcrun notarytool store-credentials "notarytool-profile" \
    --apple-id "your@email.com" \
    --team-id "YOUR_TEAM_ID" \
    --password "app-specific-password"
  ```
- [ ] Run signed release: `APPLE_ID="..." APPLE_TEAM_ID="..." ./Scripts/build-release.sh`
- [ ] Verify Gatekeeper accepts without warnings: `spctl --assess --type execute /path/to/app`

**Phase 2: Trial + Licensing System**
- [ ] Choose licensing approach:
  - **Option A — Gumroad / LemonSqueezy**: Hosted payment page, license key validation via API, minimal code. Best for solo dev.
  - **Option B — RevenueCat**: Handles subscriptions/purchases, macOS SDK available, receipt validation. Best if considering subscriptions later.
  - **Option C — Custom**: Generate license keys yourself, validate offline with cryptographic signing. Most control, most work.
- [ ] Implement trial logic in `AppState`:
  ```swift
  @AppStorage("firstLaunchDate") var firstLaunchDate: Double = 0  // TimeInterval
  @AppStorage("licenseKey") var licenseKey: String = ""

  var isTrialActive: Bool {
      let firstLaunch = Date(timeIntervalSince1970: firstLaunchDate)
      return Date().timeIntervalSince(firstLaunch) < trialDuration
  }
  var isLicensed: Bool { !licenseKey.isEmpty && validateLicense(licenseKey) }
  var canUseApp: Bool { isTrialActive || isLicensed }
  ```
- [ ] Add trial duration constant to `Constants.swift` (e.g., 7 or 14 days)
- [ ] Create `LicenseView.swift`:
  - Show trial days remaining
  - "Enter License Key" text field
  - "Buy License" button → opens payment page URL
  - Validation feedback (valid/invalid key)
- [ ] Gate `ClipboardMonitor.checkClipboard()` behind `appState.canUseApp`
- [ ] Show trial expiry notice in `MenuBarView` when trial is ending (< 2 days left)
- [ ] Add "Buy License" menu item in `MenuBarView` when unlicensed

**Phase 3: Pricing & Distribution**
- [ ] Set pricing (suggested: $9-15 USD lifetime, based on comparable macOS utilities)
- [ ] Create landing page / product page
- [ ] Set up payment provider (Gumroad/LemonSqueezy page)
- [ ] Update README with purchase link
- [ ] Distribute signed+notarized DMG via GitHub Releases or landing page
- [ ] Add analytics to track trial-to-purchase conversion (optional, privacy-respecting)

**Acceptance**: Users can download, use the free trial for N days, purchase a lifetime license, enter the key, and continue using the app indefinitely. Signed DMG installs without Gatekeeper warnings.

---

## Interface Contracts

These signatures are implemented and must be maintained:

### AppState
```swift
@MainActor
class AppState: ObservableObject {
    static let shared = AppState()
    @AppStorage("isEnabled") var isEnabled: Bool              // default: true
    @AppStorage("launchAtLogin") var launchAtLogin: Bool      // default: false
    @AppStorage("detectionSensitivity") var detectionSensitivity: Int  // default: 2
    @AppStorage("includeRTF") var includeRTF: Bool            // default: true
    @Published var conversionCount: Int                        // default: 0
    @Published var lastConversionDate: Date?                   // default: nil
}
```

### MarkdownDetector
```swift
struct MarkdownDetector {
    init()  // pre-compiles 15 NSRegularExpression patterns
    func detect(text: String, threshold: Int) -> Bool
    func score(text: String) -> Int
}
```

### MarkdownConverter
```swift
struct MarkdownConverter {
    func convert(markdown: String) -> (html: String, rtf: Data?)
}
```

### ClipboardWriter
```swift
struct ClipboardWriter {
    func write(plainText: String, html: String, rtf: Data?)
}
```

### ClipboardMonitor
```swift
class ClipboardMonitor {
    init(appState: AppState)
    func start()
    func stop()
}
```

### PasteboardTypes
```swift
extension NSPasteboard.PasteboardType {
    static let markdownPasteMarker: NSPasteboard.PasteboardType
}
```

### Constants
```swift
enum Constants {
    static let appName: String             // "MarkdownPaste"
    static let bundleID: String            // "com.jonathancheung.MarkdownPaste"
    static let pollingInterval: TimeInterval  // 0.5
    static let maxContentSize: Int            // 100_000
    static let defaultDetectionThreshold: Int // 2
}
```

---

## Verification Plan

1. **Unit tests**: `xcodebuild test` — 56 tests across detector (22), converter (23), writer (11)
2. **Manual QA matrix** (see Milestone 8 for full checklist):
   - Copy Markdown from Terminal → paste in Slack → should render formatted
   - Copy plain English → paste → should remain plain text
   - Copy from web browser (already rich) → paste → original behavior preserved
   - Copy GFM table → paste in Apple Notes → should render as table
   - Toggle app off → copy Markdown → paste → should remain raw
3. **Performance**: Detector <5ms, converter <100ms on typical documents
4. **Distribution**: Install from unsigned DMG on clean Mac, verify right-click → Open bypass works, verify launch-at-login
