# Marksmith - macOS Menu Bar App Implementation Plan

## Context

Copying text from `.md` files and pasting into apps like Slack or Telegram results in raw Markdown syntax (hashes, asterisks, etc.) appearing literally instead of rendering as formatted text. This happens because text editors only place plain text on the clipboard — without an HTML or RTF representation, receiving apps have nothing to render.

**Goal**: Build a native macOS menu bar app that automatically monitors the clipboard, detects Markdown content, converts it to rich text (HTML + RTF), and writes it back — so pasting "just works" with formatting in any app.

---

## Architecture Overview

- **App type**: Menu bar-only utility (no Dock icon, no main window)
- **Tech**: Swift + SwiftUI, macOS 13+ (Ventura) for `MenuBarExtra` and `SMAppService`
- **Bundle ID**: `com.jonathancheung.Marksmith`
- **Single dependency**: Apple's `swift-markdown` (SPM) — bundles `cmark-gfm` for full GFM support
- **Distribution**: Code-signed + notarized `.dmg`

### Data Flow

```
Timer (0.5s) → changeCount changed?
  → Self-marker present? Skip
  → Already has HTML/RTF? Skip
  → Extract plain text
  → MarkdownDetector: heuristic score ≥ threshold?
  → MarkdownConverter: MD → AST → HTML (styled) + RTF
  → ClipboardWriter: write .string + .html + .rtf + .marker back
```

---

## Project Structure

```
Marksmith/
├── Marksmith.xcodeproj          # Generated by XcodeGen
├── Marksmith/
│   ├── App/
│   │   ├── MarksmithApp.swift   # @main, MenuBarExtra + Settings scenes
│   │   ├── AppDelegate.swift        # Lifecycle, start/stop monitor
│   │   └── AppState.swift           # @MainActor singleton, @AppStorage prefs
│   ├── Views/
│   │   ├── MenuBarView.swift        # Dropdown: toggle, status, settings, quit
│   │   ├── SettingsView.swift       # General + Detection + License tabs
│   │   └── LicenseSettingsView.swift # Trial status, key entry, buy link (v2.0)
│   ├── Models/
│   │   └── LicenseState.swift       # Enum: .trial, .expired, .licensed (v2.0)
│   ├── Services/
│   │   ├── ClipboardMonitor.swift   # Timer-based NSPasteboard polling
│   │   ├── MarkdownDetector.swift   # 15 weighted regex patterns
│   │   ├── MarkdownConverter.swift  # swift-markdown HTMLVisitor → HTML + RTF
│   │   ├── ClipboardWriter.swift    # NSPasteboardItem multi-format write
│   │   └── LicenseManager.swift     # Trial tracking, API validation (v2.0)
│   ├── Utilities/
│   │   ├── Constants.swift          # Polling interval, max size, threshold
│   │   └── PasteboardTypes.swift    # Marker type extension
│   └── Resources/
│       ├── Assets.xcassets/         # AppIcon
│       └── Info.plist               # LSUIElement=YES, NSPasteboardUsageDescription
├── MarksmithTests/
│   ├── MarkdownDetectorTests.swift  # 22 tests
│   ├── MarkdownConverterTests.swift # 23 tests
│   ├── ClipboardWriterTests.swift   # 11 tests
│   ├── LicenseStateTests.swift      # ~12 tests (v2.0)
│   └── LicenseManagerTests.swift    # ~15 tests (v2.0)
├── Scripts/
│   └── build-release.sh            # Archive, sign, notarize, DMG
├── ExportOptions.plist              # developer-id export config
├── project.yml                      # XcodeGen configuration
└── README.md
```

---

## Key Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Clipboard monitoring | Polling (0.5s Timer) | macOS has no clipboard change notification API. <1% CPU. |
| Loop prevention | Marker pasteboard type + changeCount | Dual strategy prevents all re-processing of own writes |
| Skip rich content | Check for existing .html/.rtf | Don't re-process content copied from web/docs |
| Markdown parser | Apple's swift-markdown | Official, bundles cmark-gfm, full GFM, HTMLFormatter built-in |
| RTF generation | NSAttributedString pipeline | Built into AppKit, no extra dependency |
| Sandboxing | Disabled | Clipboard monitoring requires general pasteboard access; distributing via DMG (not App Store) |
| Min macOS version | 13.0 (Ventura) | Required for MenuBarExtra and SMAppService APIs |
| Settings window | SwiftUI `SettingsLink` | Native macOS 13+ API, replaces fragile `NSApp.sendAction(Selector(...))` |
| AppState thread safety | `@MainActor` | Required for SwiftUI compatibility; Timer fires on main thread |

---

## Edge Cases Handled

- **Self-triggered changes**: Marker type + changeCount tracking prevents infinite loops
- **Already-rich clipboard**: Skipped if .html or .rtf already present
- **Very large content**: Skip if >100KB to avoid blocking main thread
- **Non-text clipboard** (images, files): `guard let plainText` returns early
- **Empty/whitespace clipboard**: Trimmed check prevents processing blank content
- **macOS 16 privacy prompts**: NSPasteboardUsageDescription provides rationale; graceful nil handling if denied
- **False positive detection**: Low default threshold (2) catches most Markdown; user can increase to 5 for conservative mode
- **XSS in code blocks**: HTML entities escaped in all text output including code blocks

---

## Completed Milestones

### Milestone 1: Project Skeleton ✅

- [x] Create Xcode project directory structure
- [x] Create `project.yml` (XcodeGen) with macOS 13 deployment target
- [x] Add `swift-markdown` SPM dependency (`https://github.com/swiftlang/swift-markdown.git`, from 0.4.0)
- [x] Create `Info.plist` with `LSUIElement = true` and `NSPasteboardUsageDescription`
- [x] Create `Assets.xcassets` with `AppIcon.appiconset`
- [x] Create `Marksmith.entitlements` (sandbox disabled)
- [x] Create `Constants.swift` — app name, bundle ID, polling interval (0.5s), max content size (100KB), default threshold (2)
- [x] Create `PasteboardTypes.swift` — `NSPasteboard.PasteboardType.markdownPasteMarker` extension
- [x] Create `AppState.swift` — `@MainActor` singleton with `@AppStorage` properties, `@Published` runtime state, `SMAppService` login item management
- [x] Create `MarksmithApp.swift` — `@main`, `MenuBarExtra` with custom `MenuBarIcon` template image, `Settings` scene
- [x] Create `AppDelegate.swift` — `NSApplicationDelegateAdaptor`, creates and manages `ClipboardMonitor`

---

### Milestone 2: Markdown Detection Engine ✅

- [x] Create `MarkdownDetector.swift` with 15 pre-compiled `NSRegularExpression` patterns (all with correct `.anchorsMatchLines` options where needed)
- [x] Implement `score(text:) -> Int` — sum weighted matches, cap each pattern at 3 matches
- [x] Implement `detect(text:threshold:) -> Bool` — score ≥ threshold
- [x] Create `MarkdownDetectorTests.swift` — 22 tests: 15+ positive, 6 negative, 6 edge cases

---

### Milestone 3: Markdown-to-Rich-Text Converter ✅

- [x] Create `MarkdownConverter.swift` with `convert(markdown:) -> (html: String, rtf: Data?)`
- [x] Implement `HTMLVisitor` conforming to `MarkupVisitor` protocol with all GFM elements (22 visit methods)
- [x] Implement CSS styling wrapper with system font, code backgrounds, table borders, blockquote styling
- [x] Implement RTF generation via `NSAttributedString(html:documentAttributes:)`
- [x] Implement HTML entity escaping (`<`, `>`, `&`, `"`)
- [x] Create `MarkdownConverterTests.swift` — 23 tests covering all elements, RTF, escaping, CSS

---

### Milestone 4: Clipboard Read/Write Integration ✅

- [x] Create `ClipboardWriter.swift` with marker-inclusive multi-format write
- [x] Create `ClipboardMonitor.swift` with 10-step guard pipeline, weak self timer, RunLoop.common mode
- [x] Create `ClipboardWriterTests.swift` — 11 tests for types, marker, content integrity
- [x] Wire `AppDelegate` to create and start `ClipboardMonitor`

---

### Milestone 5: Menu Bar UI & Settings ✅

- [x] Create `MenuBarView.swift` — toggle, status display, `SettingsLink`, quit button with keyboard shortcuts
- [x] Create `SettingsView.swift` — `TabView` with General tab (enable, login, RTF toggles) and Detection tab (sensitivity slider with labels)
- [x] `MarksmithApp.swift` includes both `MenuBarExtra` and `Settings` scenes with `@EnvironmentObject`

---

### Milestone 6: Project Configuration & Build ✅

- [x] Finalize `project.yml` with app target, test target, SPM dependency, signing config
- [x] Create `Scripts/build-release.sh` (archive, sign, notarize, DMG with create-dmg fallback to hdiutil)
- [x] Create `ExportOptions.plist` (method: developer-id, automatic signing)
- [x] XcodeGen successfully generates `.xcodeproj`

---

## Remaining Tasks

### Milestone 7: Build Verification & Xcode Setup ✅

**Goal**: Verify the project compiles and all tests pass in Xcode.

- [x] Run `xcodegen generate` to create fresh `.xcodeproj`
- [x] Build the app: `xcodebuild build -project Marksmith.xcodeproj -scheme Marksmith`
- [x] Run all tests: `xcodebuild test -project Marksmith.xcodeproj -scheme Marksmith`

**Result**: Build succeeded with 0 errors. All 70 tests pass.

---

### Milestone 8: Manual QA Testing ✅
**Goal**: Verify end-to-end functionality with real clipboard operations.

- [x] Launch the app — verify it appears in the menu bar with the custom clipboard→document icon
- [x] **Positive conversion tests**:
  - [x] Copy `# Heading\n**bold**\n- list item` from Terminal → paste in TextEdit → should render formatted
  - [x] Copy a full GFM document with tables → paste in Apple Notes → table should render
  - [x] Copy code block with triple backticks → paste in rich text app → should show code formatting
  - [x] Copy task list `- [x] Done\n- [ ] Todo` → paste → should show checkboxes
- [x] **Negative tests (should NOT convert)**:
  - [x] Copy plain English sentence → paste → should remain plain text
  - [x] Copy text from a web browser (already has HTML) → paste → original rich formatting preserved
  - [x] Copy an image → paste → image should paste normally
  - [x] Copy text > 100KB → paste → should not be processed
- [x] **Settings tests**:
  - [x] Toggle "Enabled" off → copy Markdown → paste → should remain raw
  - [x] Toggle "Enabled" back on → copy Markdown → paste → should convert
  - [x] Adjust sensitivity slider to 5 → copy simple Markdown → should NOT convert (too few patterns)
  - [x] Adjust sensitivity slider to 1 → copy simple Markdown → should convert
  - [x] Toggle "Include RTF" off → verify paste still works (HTML-only)
  - [x] Toggle "Launch at Login" → verify `SMAppService` registration (check System Settings > General > Login Items)
- [x] **Menu bar tests**:
  - [x] Verify conversion counter increments after each conversion
  - [x] Verify "Last: X ago" updates with relative time
  - [x] Verify Settings... opens the preferences window
  - [x] Verify Quit terminates the app
- [x] **Edge case tests**:
  - [x] Rapid copy-paste (multiple copies in < 0.5s) — no crashes, no infinite loops
  - [x] Copy Markdown, then copy non-Markdown — second copy should not have rich text from first
  - [x] App remains responsive during conversion of large Markdown (50-100KB)

**How to execute**: Run the app from Xcode (Product > Run or ⌘R), then perform each test manually. Keep a checklist of pass/fail results.

**Acceptance**: All tests pass. No crashes, no infinite loops, no incorrect conversions.

---

### Milestone 9: App Icon Design ✅
**Goal**: Create a proper app icon for the menu bar and app bundle.

- [x] Design a 1024x1024 app icon (the master size)
- [x] Export to all required sizes for `AppIcon.appiconset`
- [x] Place PNGs in `Marksmith/Resources/Assets.xcassets/AppIcon.appiconset/`
- [x] Update `Contents.json` with filename references
- [x] Custom menu bar icon (18x18 template image) — `MenuBarIcon.imageset` generated by `Scripts/generate-menubar-icon.swift`

**How to execute**: Use a design tool (Figma, Sketch, or macOS Preview) to create the icon. Export at each resolution. Copy PNGs into the asset catalog and update the JSON manifest.

**Acceptance**: App icon appears in Finder, Dock (if shown), and About window. Menu bar shows a clear, recognizable icon.

---

### Milestone 10: Performance Profiling ✅
**Goal**: Verify the app meets performance targets and doesn't drain battery.

XCTest `measure {}` results (Debug build, Apple M-series):

- [x] Measure `MarkdownDetector.score()` — **~0.5ms typical, ~2ms on 27KB** — well under 5ms target ✓
- [x] Measure `MarkdownConverter.convert()` — **~12ms typical** — under 100ms target ✓ (27KB complex doc: ~220ms, acceptable given the 100KB size guard)
- [x] Test with large Markdown files to verify the size guard works — fixture is 27KB, passes `< 100KB` guard assertion ✓
- [~] Measure CPU usage during idle polling — skipped (README states <1%; acceptable for v1.0)
- [~] Measure memory usage at rest — skipped
- [~] Verify no memory leaks — skipped

Performance tests added to `MarksmithTests/MarkdownPerformanceTests.swift` (5 tests, all passing).

**Acceptance**: Detector <5ms ✓, converter <100ms for typical content ✓. Idle CPU and memory require manual Instruments profiling.

---

### Milestone 11: GitHub Repository Setup for Production
**Goal**: Ensure the repository and GitHub settings are correctly configured before the first public release.

**Repository metadata**
- [ ] Confirm repo visibility is **Public** (required for free GitHub Actions minutes and GitHub Releases)
- [ ] Set repository **Description** (e.g., "macOS menu bar utility that auto-converts Markdown clipboard content to rich text")
- [ ] Add **Topics/tags**: `macos`, `swift`, `swiftui`, `menu-bar`, `clipboard`, `markdown`, `markdown-converter`, `utility`
- [ ] Set **Website** field to the future landing page or GitHub Pages URL

**License**
- [x] Add a `LICENSE` file — MIT (created `LICENSE` with 2025 Jonathan Cheung)

**Branch protection (main)**
- [ ] Go to Settings > Branches > Add branch protection rule for `main`:
  - [x] Require a pull request before merging
  - [x] Require at least 1 approval
  - [x] Require status checks to pass before merging (add the CI job once GitHub Actions is set up)
  - [x] Do not allow force pushes
  - [x] Do not allow branch deletions

**GitHub Actions CI**
- [x] Create `.github/workflows/ci.yml`
- [x] Add CI status badge to `README.md`
- [ ] Confirm CI passes on `main` before the first release

**Issue & PR templates**
- [x] Create `.github/ISSUE_TEMPLATE/bug_report.md`
- [x] Create `.github/ISSUE_TEMPLATE/feature_request.md`
- [x] Create `.github/PULL_REQUEST_TEMPLATE.md`

**Security policy**
- [x] Create `SECURITY.md`

**Dependabot**
- [x] Create `.github/dependabot.yml`

**Housekeeping**
- [x] Verify `.gitignore` excludes: `build/`, `*.xcuserstate`, `xcuserdata/`, `DerivedData/`, `.DS_Store` — confirmed
- [ ] Disable unused GitHub features in Settings: Wiki (unless documenting there), Sponsorships (until monetisation is ready)
- [ ] Enable **GitHub Discussions** if you want community feedback before v1.0

**Acceptance**: `main` is protected, CI is green, LICENSE is present, issue templates exist, and the repo is ready to receive its first public GitHub Release.

---

### Milestone 12: Unsigned DMG Distribution ✅
**Goal**: Package the app into a `.dmg` for sharing without an Apple Developer license.

- [x] Build the Release archive — `./Scripts/build-release.sh` succeeded, DMG at `build/Marksmith.dmg`
- [x] Test the DMG — verified on Mac, Gatekeeper bypass works, app functions correctly
- [x] README covers install instructions for recipients
- [x] GitHub Release published: https://github.com/jonc102/marksmith/releases/tag/v1.0.0

---

### Milestone 13: Polish & Enhancements (v1.1) ✅
**Goal**: About window — standard macOS utility feature showing app name, version, and GitHub link.

- [x] **About window**: `AboutView.swift` with app icon, version from `Bundle.main`, one-line description, and GitHub link. Opened via "About Marksmith" in the menu bar dropdown (`openWindow(id: "about")`). Non-resizable, 360×260.

---

### Milestone 14: Monetization — Free Trial + Lifetime Unlock (v2.0)
**Goal**: Monetize with a 14-day free trial and one-time lifetime purchase ($9-15 USD) via LemonSqueezy/Gumroad. Source-available under FSL (Functional Source License).

**Status**: Design complete. Implementation blocked on QA (Milestone 8).

**Key decisions**:
- **License**: FSL — source-available, converts to MIT after 2 years
- **Trial**: 14 days from first launch, full lockout on expiry
- **Payment**: LemonSqueezy/Gumroad — web checkout → license key → validate via API → cache locally
- **Gate**: Single guard in `ClipboardMonitor.checkClipboard()` — stops converting when expired
- **UX**: Trial days always visible in menu bar; purchase link in both menu bar and Settings

**Phase 1: Source-Available License & Signed Distribution**
- [ ] Add FSL `LICENSE` file (Licensor: Jonathan Cheung, Change License: MIT, Change Date: 2 years from release)
- [ ] Enroll in Apple Developer Program ($99/year)
- [ ] Set up Developer ID certificate, configure signing in `project.yml`
- [ ] Store notarization credentials
- [ ] Build signed release, verify Gatekeeper acceptance

**Phase 2: Licensing System — Files to Create**

| File | Purpose |
|------|---------|
| `Marksmith/Models/LicenseState.swift` | Enum: `.trial(daysRemaining:)`, `.expired`, `.licensed` with `canConvert`, `statusText` |
| `Marksmith/Services/LicenseManager.swift` | `@MainActor class` — trial tracking, state computation, API validation, offline caching, deactivation |
| `Marksmith/Views/LicenseSettingsView.swift` | Settings tab: trial status card, key entry + activate, validation feedback, buy link, deactivate |
| `MarksmithTests/LicenseStateTests.swift` | ~12 tests: canConvert, isExpired, statusText for each state |
| `MarksmithTests/LicenseManagerTests.swift` | ~15 tests: trial computation, state transitions, API validation (mock URLProtocol) |

**Phase 2: Licensing System — Files to Modify**

| File | Changes |
|------|---------|
| `Constants.swift` | Add `trialDurationDays` (14), `purchaseURL`, `licenseValidationURL`, `productID`, `licenseValidationTimeout` (15s) |
| `AppState.swift` | Add `@AppStorage`: `firstLaunchDate`, `licenseKey`, `licenseValidatedAt`; add `@Published licenseState`; add `licenseManager` + `setupLicenseManager()`; change `private init()` to `init()` |
| `AppDelegate.swift` | Add `AppState.shared.setupLicenseManager()` before monitor creation |
| `ClipboardMonitor.swift` | Add step 0 guard: `guard appState.licenseState.canConvert else { return }` |
| `MenuBarView.swift` | Add license section: trial countdown + "Buy License..." during trial; "Trial Expired" + "Unlock" when expired; "Licensed" badge |
| `SettingsView.swift` | Add `case license` to `SettingsTab`, wire `LicenseSettingsView` |

**Phase 2: Key Design Decisions**
1. `LicenseState` computed from `@AppStorage` values, never stored — no stale state
2. Trial uses UserDefaults — acceptable for $9-15 utility; Keychain later if needed
3. Validate-once, use-forever — no periodic re-validation for lifetime purchase
4. Generic API: supports LemonSqueezy (`valid: true`) and Gumroad (`success: true`)
5. Timer keeps running when expired (zero-cost guard, instant resume on activation)
6. Purchase entry point visible in menu bar AND Settings during trial (not just after expiry)

**Phase 3: Payment Provider & Distribution**
- [ ] Set up LemonSqueezy/Gumroad product ($9-15 USD lifetime)
- [ ] Replace placeholder URLs in `Constants.swift` with real values
- [ ] Create landing page
- [ ] Update README with license info and purchase link
- [ ] Distribute signed+notarized DMG

**Acceptance**: Users can download, use the 14-day free trial, purchase a lifetime license via LemonSqueezy/Gumroad, enter the key, and continue using the app indefinitely. Signed DMG installs without Gatekeeper warnings. Source code available under FSL.

---

## Interface Contracts

These signatures are implemented and must be maintained:

### AppState
```swift
@MainActor
class AppState: ObservableObject {
    static let shared = AppState()
    @AppStorage("isEnabled") var isEnabled: Bool              // default: true
    @AppStorage("launchAtLogin") var launchAtLogin: Bool      // default: false
    @AppStorage("detectionSensitivity") var detectionSensitivity: Int  // default: 2
    @AppStorage("includeRTF") var includeRTF: Bool            // default: true
    @Published var conversionCount: Int                        // default: 0
    @Published var lastConversionDate: Date?                   // default: nil

    // Licensing (v2.0)
    @AppStorage("firstLaunchDate") var firstLaunchDate: Double      // default: 0
    @AppStorage("licenseKey") var licenseKey: String                 // default: ""
    @AppStorage("licenseValidatedAt") var licenseValidatedAt: Double // default: 0
    @Published var licenseState: LicenseState                        // default: .trial(daysRemaining: 14)
}
```

### MarkdownDetector
```swift
struct MarkdownDetector {
    init()  // pre-compiles 15 NSRegularExpression patterns
    func detect(text: String, threshold: Int) -> Bool
    func score(text: String) -> Int
}
```

### MarkdownConverter
```swift
struct MarkdownConverter {
    func convert(markdown: String) -> (html: String, rtf: Data?)
}
```

### ClipboardWriter
```swift
struct ClipboardWriter {
    func write(plainText: String, html: String, rtf: Data?)
}
```

### ClipboardMonitor
```swift
class ClipboardMonitor {
    init(appState: AppState)
    func start()
    func stop()
}
```

### PasteboardTypes
```swift
extension NSPasteboard.PasteboardType {
    static let markdownPasteMarker: NSPasteboard.PasteboardType
}
```

### Constants
```swift
enum Constants {
    static let appName: String             // "Marksmith"
    static let bundleID: String            // "com.jonathancheung.Marksmith"
    static let pollingInterval: TimeInterval  // 0.5
    static let maxContentSize: Int            // 100_000
    static let defaultDetectionThreshold: Int // 2

    // Licensing (v2.0)
    static let trialDurationDays: Int              // 14
    static let purchaseURL: String                 // LemonSqueezy checkout URL
    static let licenseValidationURL: String        // LemonSqueezy API URL
    static let productID: String                   // LemonSqueezy product ID
    static let licenseValidationTimeout: TimeInterval // 15
}
```

### LicenseState (v2.0)
```swift
// Value type, computed by LicenseManager from @AppStorage values
enum LicenseState: Equatable {
    case trial(daysRemaining: Int)
    case expired
    case licensed

    var canConvert: Bool   // true for .trial and .licensed, false for .expired
    var statusText: String // "Trial: X days left", "Trial Expired", "Licensed"
}
```

### LicenseManager (v2.0)
```swift
// @MainActor, owns trial/license logic
@MainActor
class LicenseManager: ObservableObject {
    init(appState: AppState)
    var currentState: LicenseState
    func validateLicenseKey(_ key: String) async -> LicenseValidationResult
    func deactivateLicense()
}
```

---

## Verification Plan

1. **Unit tests**: `xcodebuild test` — 70 tests across detector (22), converter (23), writer (11), plus 14 additional tests
2. **Manual QA matrix** (see Milestone 8 for full checklist):
   - Copy Markdown from Terminal → paste in Slack → should render formatted
   - Copy plain English → paste → should remain plain text
   - Copy from web browser (already rich) → paste → original behavior preserved
   - Copy GFM table → paste in Apple Notes → should render as table
   - Toggle app off → copy Markdown → paste → should remain raw
3. **Performance**: Detector <5ms, converter <100ms on typical documents
4. **Distribution**: Install from unsigned DMG on clean Mac, verify right-click → Open bypass works, verify launch-at-login
5. **Monetization** (v2.0): Trial starts on first launch and expires after 14 days; expired trial blocks conversion; license key activates via API; licensed state persists across restarts; deactivation clears license and resumes expired state
